## 初始化

### 设置语言

第一步，可选，把工具设置显示英文。

工具-选项-观感

![1538924720942](assets/1538924720942.png)

### 界面简介

只做简单解释，后续做项目会慢慢用到一些其中的插件

![1538986433221](assets/1538986433221.png)

## 简单的数据库交换例子

需求：每天定时从A库的X表获取数据，搬到B库的X表，表结构一致

grid_code字段要求去掉短横线

### 新建作业

快捷键CTRL+ALT+N

模型：

![1538986264521](assets/1538986264521.png)

步骤：

开始和结束插件是必须的

获取当前系统日期，保存结果到记录集

取出记录集，替换占位符(SQL查询)，获取数据，搬迁到目标表

### 新建转换

#### 获取日期

快捷键CTRL+N

![1538986578715](assets/1538986578715.png)

获取系统当前日期

![1538986596622](assets/1538986596622.png)

格式化日期格式

![1538986642145](assets/1538986642145.png)

#### 复制数据

![1538986703596](assets/1538986703596.png)

从结果获取记录

![1538986713132](assets/1538986713132.png)

表输入

![1538986886472](assets/1538986886472.png)

格式化字符串，去掉grid_code的短横线

![1538987599236](assets/1538987599236.png)

输出到目标表，注意选目标表

![1538987632683](assets/1538987632683.png)

### 运行

![1538990013994](assets/1538990013994.png)

就可以查看运行结果

![1538990083631](assets/1538990083631.png)

可以查看性能监控图

### 一些问题

#### 结果集和变量的区别?

结果集主要用于替换占位符

变量主要用于替换某些不能使用占位符的情况，特别注意的是，如果在A转换里面设置了变量，是不能在A转换中使用，必须在下一个转换或者作业环节才能使用，而且，变量是有作用域范围的，需要根据实际需要指定好

参考：多表复制的例子

模型：https://blog.csdn.net/sky08050025/article/details/79608231

变量设置：https://blog.csdn.net/u012848709/article/details/63254593/

![img](assets/20180322184706399)

表输出的时候，表名无法使用占位符实现

 

#### 每个结果集执行一次Job

应用场景，当需要用到同步多个表数据的时候，可以采用单个作业，多次循环的方式，但是需要设置子作业或者转换为每个输入结果执行一次。

![1538990906628](assets/1538990906628.png)

#### 分批执行，分页采集数据

在数据库输入和输出的过程中，可以设定每次提交的数量，因为表输入一般都是直接把整个数据库表的数据load进内存，再处理输出到目标数据库，在数据量较大的情况下，需要分批提交

作业示例

![1539001865085](assets/1539001865085.png)

设置变量

![1539001890185](assets/1539001890185.png)

设置分页数

![1539001931190](assets/1539001931190.png)

![1539001994509](assets/1539001994509.png)

![1539002011255](assets/1539002011255.png)

获取分页总数之后，设置步进序列

![1539002046272](assets/1539002046272.png)

![1539002074206](assets/1539002074206.png)

![1539002087784](assets/1539002087784.png)

子作业，开始复制表数据

![1539002124314](assets/1539002124314.png)

设置开始变量

![1539002158220](assets/1539002158220.png)

![1539002141508](assets/1539002141508.png)

![1539002196666](assets/1539002196666.png)

开始复制数据

![1539002301730](assets/1539002301730.png)

![1539002340914](assets/1539002340914.png)

![1539002364613](assets/1539002364613.png)

#### 为什么分批执行使用变量，而不使用JS循环

在第一次搜索资料的时候，使用的就是JS循环，但是在大数据量的时候，kettle每次都内存溢出

而且很明显这是一个固有的问题，PDI不使用JS循环

https://jira.pentaho.com/browse/PDI-1463

在数据量小的时候，还是可以使用的，但是不建议

主作业：

![1539002520444](assets/1539002520444.png)

设置变量

![1539002756425](assets/1539002756425.png)

![1539002781045](assets/1539002781045.png)

![1539002805391](assets/1539002805391.png)

![1539002818798](assets/1539002818798.png)

判断

![1539002844711](assets/1539002844711.png)

判断成立，进入数据复制步骤

![1539002874786](assets/1539002874786.png)

![1539002913440](assets/1539002913440.png)

![1539002940471](assets/1539002940471.png)

计数加1

![1539002974532](assets/1539002974532.png)

#### 支持事务吗？

开源的社区版本只有转换支持事务，作业不支持事务

参考：https://wiki.pentaho.com/display/EAI/.08+Transformation+Settings

配置方法，每隔50000条作为一次事务，如果在15w的时候失败，那么前面10w数据是成功提交的。

![1539003085015](assets/1539003085015.png)

#### 优化？

参考：https://www.cnblogs.com/lsy-blogs/archive/2018/01/11/8268318.html的章节：

十六、使用kettle时必须要注意并且做到的几个要点

#### 支持远程执行？

放在集群的单元说

#### 怎么记录运行日志？

在下一章节，数据库资源库里面解释









